## Поддержка AVRO

Внешняя компонента может формировать файлы в бинарном формате **AVRO**, который поддерживает передачу данных по схемам, которые записываются в заголовок файла формата **AVRO** при его создании.


### Формирование сообщения в формате AVRO
Сохранение схемы, которая будет использоваться для **AVRO**.
```1С
СохранитьСхемуAVRO(ИмяСхемыJSON, СхемаJSON);
```

**ИмяСхемыJSON** - Строка. Обязательный. Имя схемы.

**СхемаJSON** - Строка. Обязательный. Схема, по которой формируются данные (см. параметр **ДанныеJSON** процедуры **ПреобразоватьВФорматAVRO**). Схема должна быть представлена в следующем виде:
```json
{
  "type": "record",
  "name": "user",
  "fields": [
    {
      "name": "id",
      "type": "string"
    },
    {
      "name": "name",
      "type": "string"
    },
    {
      "name": "phone",
      "type": [
        "null",
        "string"
      ]
    }
   ]
}
```
**Возвращает** значение типа булево - "Истина", если операция выполнена успешно.
"Ложь", если была ошибка. 
Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.

Пример использования метода **СохранитьСхемуAVRO**:
```1С
ИмяСхемыJSON = "user";

СхемаJSON = "{
|  ""type"": ""record"",
|  ""name"": ""user"",
|  ""fields"": [
|    {
|      ""name"": ""id"",
|      ""type"": ""string""
|    },
|    {
|      ""name"": ""name"",
|      ""type"": ""string""
|    },
|    {
|      ""name"": ""phone"",
|      ""type"": [
|        ""null"",
|        ""string""
|      ]
|    }
|   ]
|}";

Результат = Компонента.СохранитьСхемуAVRO(
  ИмяСхемыJSON,
  СхемаJSON
);
	
Если Не Результат Тогда
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

### Формирование **AVRO** из JSON
```1С
ПреобразоватьВФорматAVRO(ДанныеJSON, ИмяСхемыJSON);
``` 

**ДанныеJSON** - Строка. Обязательный. Данные в формате **JSON**, представленные в следующем виде:
```json
{
  "id":    ["1", "2", "3"],
  "name":  ["Ivan", "Maksim", "Vitaly"],
  "phone": ["+79115672342", null, "+79185172317"],
  "age":   [null, 45, 25] 
}
``` 

Такой массив определяет 3 объекта:
```json
[
  {
    "id":    "1",
    "name":  "Vasiliy",
    "phone": "+79115672342",
    "age":   null
  },
  {
    "id":    "2",
    "name":  "Maksim",
    "phone": null,
    "age":   45
  },
  {
    "id":    "3",
    "name":  "Vitaly",
    "phone": "+79185172317",
    "age":   25
  }
]
``` 

Пример использования метода **ПреобразоватьВФорматAVRO**:
```1С
ДанныеJSON = "{
|  ""id"":    [""1"", ""2"", ""3""],
|  ""name"":  [""Ivan"", ""Maksim"", ""Vitaly""],
|  ""phone"": [""+79115672342"", null, ""+79185172317""],
|  ""age"":   [null, 45, 25] 
|}";

ИмяСхемыJSON = "user";

Результат = Компонента.ПреобразоватьВФорматAVRO(
  ДанныеJSON,
  ИмяСхемыJSON
);
	
Если Не Результат Тогда
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

**<span style="color: blue">Обратите внимание, </span>** что:
* в каждом поле должен быть массив с одинаковым количеством элементов;
* поля должны быть перечислены строго в той последовательности, в которой определены в схеме (описание схемы далее);
* поддерживаются следующие типы: AVRO_STRING, AVRO_LONG, AVRO_INT, AVRO_FLOAT, AVRO_DOUBLE, AVRO_BOOL, AVRO_NULL, AVRO_UNION.

**ИмяСхемыJSON** - Строка. Обязательный. Имя схемы, которая ранее был сохранена процедурой **СохранитьСхемуAVRO**

**Возвращает** значение типа булево - "Истина", если операция выполнена успешно.
"Ложь", если была ошибка. 
Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.
 


### Отправка данных в формате AVRO в Kafka

В случае успешного формирования файла **AVRO** данные можно отправить в соответствующий топик в **Kafka** при помощи методов.

### Асинхронная отправка

Для **асинхронной** отправки сообщения необходимо использовать метод **ОтправитьСообщениеAVRO**. Возвращаемое значение аналогично методу **ОтправитьСообщение**.

**Топик** - Строка.

**Партиция** - Число. Если не указано значение, то по умолчанию запись производится в 0 раздел.

**Ключ** - Строка. Необязательный параметр. Ключ сообщения, который может использоваться в темах с уплотнением сообщений по ключу.

**Заголовки** - Строка. Перечень заголовков, состоящих из ключа и значения в следующем формате "ключ1,значение1;ключ2,значение2"



Пример использования метода **ОтправитьСообщениеAVRO**:
```1С
Топик = "USER";

Результат = Компонента.ОтправитьСообщениеAVRO(
  Топик,
  ,
  "key"
);
	
Если Результат == -1 Тогда
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```


#### Синхронная отправка

Для **синхронной** отправки необходимо использовать метод **ОтправитьСообщениеAVROСОжиданиемРезультата**, состав параметров и возвращаемое значение аналогичны методу асинхронной отправки **ОтправитьСообщениеAVRO**. 

```1c
УстановитьПараметр("queue.buffering.max.ms", "1");
УстановитьПараметр("socket.blocking.max.ms", "1");
УстановитьПараметр("message.timeout.ms", "5000");

Результат = ОтправитьСообщениеAVROСОжиданиемРезультата(Сообщение, Топик, Партиция, Ключ, Заголовки)
Если Результат <> 2 Тогда	// RD_KAFKA_MSG_STATUS_PERSISTED
  ВызватьИсключение Компонента.ПолучитьСообщениеОбОшибке();
КонецЕсли;
```

Список параметров метода идентичен методу *ОтправитьСообщениеAVRO*


### Сохранение данных в формате AVRO в файл

Файл **AVRO** можно сохранить в файл:

```1c
СохранитьФайлAVRO(ИмяФайла)
```

**ИмяФайла** - Строка. Обязательный. 

**Возвращает** значение типа булево - "Истина", если операция выполнена успешно.
"Ложь", если была ошибка. 
Текст ошибки можно получить функцией **ПолучитьСообщениеОбОшибке**.

