# Чтение сообщений

Отличительной особенностью релиза >= 1.1.0 является возможность чтения сообщений из нескольких топиков в рамках одного консьюмера. Такой подход позволяет сэкономить память, но немного снижает параллельность, если после чтения сообщения выполняется бизнес логика обработки сообщения. Рекомендуется использовать именно такой подход.

Возможность создавать консьюмера на каждый топик также остается. В этом случае повышается параллельность работы, но есть нюансы с логированием информации от консьюмеров в файлы (пишется информация от последнего подключенного консьюмера).

## Последовательность использования методов компоненты и их описание

### Установка параметра group.id

Минимальный параметр, который требуется установить, для того чтобы начать получать сообщения - это **group.id**

```1c
УстановитьПараметр("group.id", ИмяВашейГруппы);
```

**ИмяВашейГруппы** - Строка.

### Установка позиции чтения

В большинстве случаев отправной точкой - откуда начинать считывать сообщения консьюмеру - управлять не нужно.
По умолчанию консьюмер начнет потреблять сообщения с последнего зафиксированного смещения. Если для темы + раздела и группы нет ранее зафиксированного смещения, он вернется к свойству конфигурации темы **auto.offset.reset**, которое установлено по умолчанию в **latest**.
Таким образом, консьюмер начинает потреблять сообщения с конца раздела (будут потребляться только новые сообщения).

Но бывают ситуации, в которых необходимо заново перечитать сообщения с определенной позиции. Для этого в компоненте реализован следующий метод:

```1c
УстановитьПозициюЧтения(Топик, Смещение, Партиция);
```

**Топик** - Строка. Имя топика.

**Смещение** - Число. Позиция, с которой нужно начать чтение.

**Партиция** - Число. Номер партиции, по умолчанию = 0.

Данный метод **не является обязательным**.

### Инициализация консьюмера

```1c
ИнициализироватьКонсьюмера(Брокер, Топики)
```

**Брокер** - Строка. Брокер, например 192.168.0.139:9092 или список брокеров, разделенных запятой. Порт можно не указывать, так же, если используется кластер, то нет необходимости указывать список всех брокеров, достаточно указать основного брокера. Брокер хранит информацию об других, связанных брокерах кластера.

**Топики** - Строка. Список топиков, разделенных запятой

Метод возвращает значение Истина - если инициализация успешно проведена, Ложь - в противном случае.

Метод является обязательным.


### Установка таймаута ожидания сообщений

Процесс получения сообщений - это по сути бесконечный цикл, внутри которого происходит проверка - а есть ли новые сообщения? Для того чтобы снизить нагрузку на процессор, используется таймаут ожидания, в рамках которого основной поток приложения блокируется на указанное время в ms.

```1c
УстановитьТаймаутОжидания(Таймаут)
```

Таймаут - Число. Указывается продолжительность блокировки основного потока приложения в ms. 

Данный метод не является обязательным, в этом случае таймаут будет составлять 500 ms.

Рекомендуется подбирать данный параметр исходя из архитектуры вашего решения и требований к скорости получения сообщений. 

### Получение сообщений

```1c
Слушать()
```

Метод возвращает по одному сообщению из буффера прочитанных сообщений.

Сообщение - строка JSON.
Структура:

+ partition - Номер раздела, из которого произведено чтение
+ offset - Смещение (позиция сообщения в разделе)
+ message - Тело сообщения
+ topic - Топик, из которого было прочитано сообщение
+ timestamp - Unix timestamp в ms. Фактическое время записи сообщения в топик и указанный раздел.

Пример сообщения:

```json
{
    "partition": "0",
    "offset": "1659",
    "message": "{\"TypeOfMessage\":\"new\",\"order_id\":123,\"status\":\"on_check\"}",
    "topic": "testTopic",
    "timestamp": "1693979913244"
}
```
Метод является обязательным.

### Фиксация смещения после чтения

В большинстве случаев использовать ручное смещение нет смысла. Вернее сказать так - в тривиальных сценариях, когда мы прочитали сообщение и сложили его, к примеру, в регистр сведений для дальнейшей обработки - можно оставить автоматическую фиксацию, которая используется по умолчанию. Но в случаях, когда после чтения необходимо выполнить определенную бизнес логику - желательно фиксировать смещения вручную.

```1c
ЗафиксироватьСмещение(Топик, Смещение, Партиция)
```

**Топик** - Строка. 

**Смещение** - Число. Значение смещения прочитанного сообщения + 1

**Партиция** - Число. Номер раздела.

Метод не является обязательным.

### Завершение работы консьюмера 

```1c
ОстановитьКонсьюмера()
```

Метод строго **обязательный**. 

## Пример кода

```1c
	РазрешеноСлушать = ПроверитьЗначениеНастройки();

	Попытка
		Компонента = Новый(СтрШаблон("AddIn.%1.simpleKafka1C", "Integration"));   
	Исключение
		Подключено = ПодключитьВнешнююКомпоненту("ОбщийМакет.КомпонентаSimpleKafka", "Integration", ТипВнешнейКомпоненты.Native, ТипПодключенияВнешнейКомпоненты.Изолированно);
		Если Подключено Тогда
			Компонента = Новый(СтрШаблон("AddIn.%1.simpleKafka1C", "Integration"));  	
		КонецЕсли;
	КонецПопытки;
	
	Если Компонента = Неопределено Тогда
		Возврат;	
	КонецЕсли;
	
	Для каждого Параметр_ Из Параметры Цикл
		Компонента.УстановитьПараметр(Строка(Параметр_.Ключ), Строка(Параметр_.Значение));	
	КонецЦикла;   	
	
	КаталогЛогов = ПолучитьКаталогЛогов();
	
	Если ЗначениеЗаполнено(КаталогЛогов) Тогда
		Компонента.УстановитьФайлЛогирования(СтрШаблон("%1%2%3.log", КаталогЛогов, ПолучитьРазделительПути(), Новый УникальныйИдентификатор));
	КонецЕсли;
 
	Результат = Компонента.ИнициализироватьКонсьюмера(Брокер, Топики); 
	
	// установка таймаута для ожидания сообщений
	Компонента.УстановитьТаймаутОжидания(Таймаут);	

	Если Не Результат Тогда  
		ТекстОшибки = СтрШаблон("Не удалось инициализировать консьюмера для топиков: %1", Топики);  
		ЗаписьЖурналаРегистрации("Интеграция Kafka. Consumer", УровеньЖурналаРегистрации.Ошибка,,, ТекстОшибки);
		Возврат;
	КонецЕсли;                 
		
	Пока РазрешеноСлушать Цикл
		
		РазрешеноСлушать = ПроверитьЗначениеНастройки();

		Если Не РазрешеноСлушать Тогда
			Прервать;	
		КонецЕсли;			      
		
		Попытка
			Сообщение = Компонента.Слушать(); 
		Исключение                	
			Компонента = Неопределено;                                                         
			ВызватьИсключение ОписаниеОшибки();
		КонецПопытки;	
				
		КлючСообщения = ПолучитьХешКлючСообщения(Сообщение);
		Если Не СообщениеПрочитано(КлючСообщения) Тогда	     
			ЗаписатьСообщениеВОчередьОбработки(); // здесь пишем в РС	
		КонецЕсли;

	КонецЦикла;  
	
	Компонента.ОстановитьКонсьюмера();	
	Компонента = Неопределено;
```